rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Plushies: Public read, Admin write
    match /plushies/{plushie} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Stories: Public read, Admin write
    match /stories/{story} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Songs: Public read, Admin write
    match /songs/{song} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Confessions: Public create (with validation), Public read (approved only), Admin moderate
    match /confessions/{confession} {
      allow create: if request.resource.data.body.size() <= 500
                   && request.resource.data.status == 'pending'
                   && request.resource.data.keys().hasAll(['body', 'status', 'createdAt']);
      
      allow read: if (resource.data.status == 'approved' && resource.data.isPublic == true) || isAdmin();
      
      allow update, delete: if isAdmin();
    }

    // Users: Admin only
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // Site Config: Public read, Admin write
    match /siteConfig/{config} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
