rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "aki@example.com"; 
      // In production, use custom claims or a specific UID check
      // return request.auth.uid == "ADMIN_UID";
    }

    function isPublic() {
      return true;
    }

    // --- USERS ---
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isAdmin();
    }

    // --- STORIES ---
    // Admin writes, Public reads
    match /stories/{storyId} {
      allow read: if isPublic();
      allow write: if isAdmin();
    }

    // --- PLUSHIES ---
    // Admin writes, Public reads
    match /plushies/{plushieId} {
      allow read: if isPublic();
      allow write: if isAdmin();
    }

    // --- SONGS ---
    // Admin writes, Public reads
    match /songs/{songId} {
      allow read: if isPublic();
      allow write: if isAdmin();
    }

    // --- CONFESSIONS ---
    // Public Create (with safety checks ideally, but basic here)
    // Public Read (only if status == 'approved')
    // Admin Write (Update status)
    match /confessions/{confessionId} {
      allow create: if isPublic() && 
                    request.resource.data.body.size() <= 500 &&
                    request.resource.data.status == 'pending';
      
      allow read: if (resource.data.status == 'approved') || isAdmin();
      
      allow update, delete: if isAdmin();
    }

    // --- AKI UPLOADS ---
    // Ideally this should be protected by the /aki password logic which is client-side.
    // Since Firebase Rules don't know about client-side passwords, 
    // we either:
    // 1. Require Auth (sign in anonymously or as admin)
    // 2. Allow public write (risk of spam)
    // Given the prompt constraints, we will allow create for now, 
    // but in a real app we'd sign in the user via custom token.
    match /akiUploads/{uploadId} {
      allow create: if isPublic(); // Relies on obscurity of the upload form / Client-side gate
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
